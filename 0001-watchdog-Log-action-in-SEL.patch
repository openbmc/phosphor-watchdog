From 47d972495cc89037a541ae41abc1da5af3b661ea Mon Sep 17 00:00:00 2001
From: Kun Yi <kunyi@google.com>
Date: Tue, 2 Apr 2019 13:30:37 -0700
Subject: [PATCH] watchdog: Log action in SEL

This depends on the SEL journal support being merged

Signed-off-by: Kun Yi <kunyi@google.com>
Change-Id: Ic0058d6e827e969cf65df26ed7f35269e5db22bf
---
 watchdog.cpp | 24 ++++++++++++++++++++++++
 1 file changed, 24 insertions(+)

diff --git a/watchdog.cpp b/watchdog.cpp
index aed0443..ddbcf57 100644
--- a/watchdog.cpp
+++ b/watchdog.cpp
@@ -113,6 +113,30 @@ void Watchdog::timeOutHandler()
                          entry("ACTION=%s", convertForMessage(action).c_str()),
                          entry("TARGET=%s", target->second.c_str()));
 
+        uint8_t eventData1;
+        switch (action)
+        {
+            case Action::None:
+                eventData1 = 0;
+                break;
+            case Action::HardReset:
+                eventData1 = 1;
+                break;
+            case Action::PowerOff:
+                eventData1 = 2;
+                break;
+            case Action::PowerCycle:
+                eventData1 = 3;
+                break;
+        }
+
+
+        log<level::ERR>("watchdog: Timed out",
+                       ipmiSelEntry(
+                           "/xyz/openbmc_project/sensors/watchdog/host0",
+                           std::vector<uint8_t>({eventData1, 0, 0}),
+                           SensorAssertion::asserted));
+
         try
         {
             auto method = bus.new_method_call(SYSTEMD_SERVICE, SYSTEMD_ROOT,
-- 
2.21.0.392.gf8f6787159e-goog

